<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Reports</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment/min/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <style>
        .card { margin: 10px; }
        .chart-container { margin-top: 30px; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="text-center my-4">Dashboard Reports</h1>

    <!-- Filters -->
    <!-- <div class="row mb-3">
        <div class="col-md-4">
            <label for="filter-date-range" class="form-label">Filter by Date Range</label>
            <input type="text" id="filter-date-range" class="form-control" placeholder="Select Date Range">
        </div>
        <div class="col-md-4">
            <label for="filter-batch" class="form-label">Filter by Batch Name</label>
            <select id="filter-batch" class="form-select">
                <option value="">All</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="filter-object-type" class="form-label">Filter by Object Type</label>
            <select id="filter-object-type" class="form-select">
                <option value="">All</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="filter-status" class="form-label">Filter by Status</label>
            <select id="filter-status" class="form-select">
                <option value="">All</option>
                <option value="Completed">Completed</option>
                <option value="Failed">Failed</option>
            </select>
        </div>
    </div> -->

    <!-- Filters Form -->
    <form id="filter-form" method="POST" action="/chart-data" class="mb-3">
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="date-range" class="form-label">Date Range</label>
                <input type="text" id="date-range" name="date_range" class="form-control" required>
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">Status</label>
                <select id="filter-status" name="status" class="form-select">
                    <option value="">All</option>
                    <!-- <option value="Completed">Completed</option>
                    <option value="Failed">Failed</option> -->
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label" style="visibility: hidden;">Submit</label>
                <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
            </div>
        </div>
    </form>

    <!-- Summary Cards -->
    <div class="row text-center">
        <div class="col-md-2">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">Total Batches</h5>
                    <p class="card-text" id="total-batches">-</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">Total Lines</h5>
                    <p class="card-text" id="total-lines">-</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">Successful Count</h5>
                    <p class="card-text" id="total-success">-</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <h5 class="card-title">Failure Count</h5>
                    <p class="card-text" id="total-failures">-</p>
                </div>
            </div>
        </div>
    </div>
    <div class="row text-center">
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">Total Time Taken</h5>
                    <p class="card-text" id="total-time-taken">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="chart-container">
        <canvas id="barChart"></canvas>
    </div>
    <!-- <div class="chart-container">
        <canvas id="pieChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="donutChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="lineChart"></canvas>
    </div> -->

    <!-- DataTable -->
    <div class="mt-4">
        <table id="dataTable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Object Type</th>
                    <th>Display Name</th>
                    <th>Type of Import</th>
                    <th>Machine Hostname</th>
                    <th>Batch Name</th>
                    <th>Count of Lines</th>
                    <th>Status</th>
                    <th>Successful Count</th>
                    <th>Failure Count</th>
                    <th>Time Taken</th>
                </tr>
            </thead>
        </table>
    </div>
</div>

<script>
    // Initialize the date range picker
    $('#date-range').daterangepicker({
        locale: {
            format: 'YYYY-MM-DD',
            separator: ' to ',
            applyLabel: 'Apply',
            cancelLabel: 'Cancel',
            customRangeLabel: 'Custom Range'
        },
        startDate: moment().startOf('month'),
        endDate: moment().endOf('month'),
        autoUpdateInput: false // Prevent automatic update of input field
    });

    // Set the initial value of the date range picker
    $(document).ready(function() {
        $('#date-range').val(moment().startOf('month').format('YYYY-MM-DD') + ' to ' + moment().endOf('month').format('YYYY-MM-DD'));
    });

    // Custom function to display selected date range in the input
    $('#date-range').on('apply.daterangepicker', function(ev, picker) {
        $(this).val(picker.startDate.format('YYYY-MM-DD') + ' to ' + picker.endDate.format('YYYY-MM-DD'));
    });

    function updateFilters() {
        $.ajax({
            type: 'POST',
            url: '/filter-data',
            data: {},
            success: function(response) {
                // Populate status filter options if needed
                // $('#filter-status').empty();
                const statuses = [...new Set(response.map(d => d['status']))];
                console.log(statuses);
                
                statuses.forEach(status => {
                    if(status) {
                        $('#filter-status').append(`<option value="${status}">${status}</option>`);
                    }
                });
            }
        });
    }

    updateFilters();

    // Function to submit the form with POST method and reload the page with new filters
    $('#filter-form').submit(function(event) {
        event.preventDefault();
        getData($(this));
    });

    function getData(formElement) {
        const formData = formElement.serialize();
        $.ajax({
            type: 'POST',
            url: '/get-data',
            data: formData,
            success: function(response) {
                // Populate charts and DataTable with new filtered data
                totals = response.totals
                data = response.data
                updateTotals(totals);
                updateCharts(data);
                updateDataTable(data);
            }
        });
    }

    getData($('#filter-form'));

    function updateTotals(data) {
        $('#total-batches').html(data.total_batches);
        $('#total-lines').html(data.total_lines);
        $('#total-success').html(data.total_success);
        $('#total-failures').html(data.total_failures);
        $('#total-time-taken').html(data.total_time_taken_str);
    }

    let barChartInstance = null;
    
    function updateCharts(data) {
        const labels = data.map(d => d['batch_name']);
        const success = data.map(d => d['successful_count']);
        const failures = data.map(d => d['failure_count']);

        if (barChartInstance) {
            barChartInstance.destroy();
        }

        barChartInstance = new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Success', data: success, backgroundColor: 'green' },
                    { label: 'Failures', data: failures, backgroundColor: 'red' }
                ]
            }
        });

        // new Chart(document.getElementById('pieChart'), {
        //     type: 'pie',
        //     data: {
        //         labels: labels,
        //         datasets: [{ data: success, backgroundColor: ['blue', 'orange', 'purple', 'green', 'red'] }]
        //     }
        // });

        // new Chart(document.getElementById('donutChart'), {
        //     type: 'doughnut',
        //     data: {
        //         labels: labels,
        //         datasets: [{ data: failures, backgroundColor: ['yellow', 'pink', 'cyan', 'teal', 'gray'] }]
        //     }
        // });

        // new Chart(document.getElementById('lineChart'), {
        //     type: 'line',
        //     data: {
        //         labels: labels,
        //         datasets: [
        //             { label: 'Success', data: success, borderColor: 'green', fill: false },
        //             { label: 'Failures', data: failures, borderColor: 'red', fill: false }
        //         ]
        //     },
        //     options: { scales: { x: { stacked: true }, y: { stacked: true } } }
        // });
    }

    function updateDataTable(data) {
        $('#dataTable').DataTable({
            data: data,
            destroy: true, // Destroy existing DataTable before creating a new one
            columns: [
                { data: 'date', title: 'Date' },
                { data: 'object_type(real_name)', title: 'Object Type' },
                { data: 'object_type(display_name)', title: 'Display Name' },
                { data: 'type_ofimport', title: 'Type of Import' },
                { data: 'machine_hostname', title: 'Machine Hostname' },
                { data: 'batch_name', title: 'Batch Name' },
                { data: 'count_of_lines_in_batch_file', title: 'Count of Lines' },
                { data: 'status', title: 'Status' },
                { data: 'successful_count', title: 'Successful Count' },
                { data: 'failure_count', title: 'Failure Count' },
                { data: 'time_taken', title: 'Time Taken' }
            ]
        });
    }
</script>
</body>
</html>
